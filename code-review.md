# コードレビュー報告書

## 実施日時
2025年12月7日

## レビュー対象
言い換えメーカー（NewsSkins）プロジェクト全体

---

## エグゼクティブサマリー

本プロジェクトは、tRPC + React + Drizzle ORM + Gemini APIを活用した、ニュース記事を15種類の文体に変換するWebアプリケーションです。全体的なアーキテクチャは良好ですが、セキュリティ、エラーハンドリング、パフォーマンス面で改善の余地があります。

**総合評価**: B+（良好だが改善の余地あり）

---

## 1. 設計（責務分離、関数の凝集度、依存関係）

### 🔴 優先度S: 重大な設計上の問題

#### S-1: APIキーのクライアントサイド露出リスク
**問題点**: `client/src/pages/Home.tsx`でユーザーが入力したGemini APIキーを直接tRPC経由でサーバーに送信し、サーバー側で使用している。これにより、悪意のあるユーザーが他人のAPIキーを不正利用する可能性がある。

**影響**: セキュリティ侵害、APIキーの不正利用、コスト増加

**改善理由**: APIキーは機密情報であり、クライアントからの直接送信は避けるべき。サーバー側で暗号化して保存し、ユーザー認証と紐付けて管理する必要がある。

**修正方針**:
- APIキーをデータベースに暗号化して保存
- ユーザー認証後、サーバー側でAPIキーを復号化して使用
- クライアントからは暗号化されたトークンのみを受け取る

---

#### S-2: 無制限なLLM API呼び出しによるコスト爆発リスク
**問題点**: `server/routers.ts`の`transform.transform`プロシージャにレート制限やクォータ管理が実装されていない。悪意のあるユーザーまたはバグにより、無限にGemini APIを呼び出される可能性がある。

**影響**: 予期しない高額なAPI利用料金、サービス停止

**改善理由**: 外部API呼び出しには必ずレート制限とクォータ管理を実装すべき

**修正方針**:
- ユーザーごとの1日あたりの変換回数制限を実装
- IPアドレスベースのレート制限を追加
- データベースに使用量を記録し、上限に達したらエラーを返す

---

### 🟡 優先度A: 重要な設計上の問題

#### A-1: エラーハンドリングの不足
**問題点**: `server/transform.ts`の`transformArticle`関数で、Gemini API呼び出し失敗時のエラーハンドリングが不十分。ネットワークエラー、タイムアウト、APIレート制限エラーなどが適切に処理されていない。

**影響**: ユーザーに不親切なエラーメッセージ、デバッグ困難

**改善理由**: 外部API呼び出しは常に失敗する可能性があり、各エラーケースに応じた適切な処理が必要

**修正方針**:
- try-catchブロックで各エラーケースを分類
- ユーザーフレンドリーなエラーメッセージを返す
- リトライロジックを実装（指数バックオフ）

---

#### A-2: データベーススキーマの正規化不足
**問題点**: `drizzle/schema.ts`の`transformHistory`テーブルに`skinKey`と`skinName`の両方が保存されている。`skinName`は`SKINS`定数から導出可能であり、冗長。

**影響**: データ整合性リスク、ストレージの無駄

**改善理由**: データベースの正規化原則に従い、冗長なデータを排除すべき

**修正方針**:
- `skinName`カラムを削除
- クエリ時に`skinKey`から`SKINS`定数を参照して`skinName`を取得

---

#### A-3: 入力検証の不足
**問題点**: `server/routers.ts`の`transform.transform`プロシージャで、`articleText`の長さ制限が5000文字に設定されているが、サーバー側での検証が不十分。クライアント側のバリデーションのみに依存している。

**影響**: 悪意のあるユーザーが大量のテキストを送信し、サーバーリソースを消費

**改善理由**: クライアント側のバリデーションは回避可能であり、サーバー側での検証が必須

**修正方針**:
- zodスキーマで`articleText`の最大長を明示的に検証
- 不正な入力に対して適切なエラーメッセージを返す

---

### 🟢 優先度B: 改善推奨

#### B-1: コンポーネントの肥大化
**問題点**: `client/src/pages/Home.tsx`が500行を超えており、複数の責務（UI表示、状態管理、API呼び出し、バリデーション）を持っている。

**影響**: 保守性の低下、テストの困難さ

**改善理由**: 単一責任の原則に従い、コンポーネントを分割すべき

**修正方針**:
- `SkinSelector`、`ArticleInput`、`AdvancedSettings`などのサブコンポーネントに分割
- カスタムフックで状態管理ロジックを抽出

---

#### B-2: マジックナンバーの存在
**問題点**: コード内に`5000`（文字数制限）、`8192`（maxOutputTokens）などのマジックナンバーが散在している。

**影響**: 保守性の低下、変更時のミス

**改善理由**: 定数として定義し、意味を明確にすべき

**修正方針**:
- `shared/const.ts`に定数を定義
- すべての箇所で定数を参照

---

### 🔵 優先度C: 軽微な改善

#### C-1: コメントの不足
**問題点**: 複雑なビジネスロジック（特に`server/transform.ts`）にコメントが不足している。

**影響**: 新規開発者のオンボーディング困難

**改善理由**: コードの可読性向上

**修正方針**:
- 各関数にJSDocコメントを追加
- 複雑なロジックに説明コメントを追加

---

## 2. 例外処理・エラーハンドリング

### 🔴 優先度S: 重大な問題

#### S-3: Gemini API呼び出しのタイムアウト未設定
**問題点**: `server/_core/llm.ts`の`invokeLLM`関数にタイムアウト設定がない。APIが応答しない場合、リクエストが永遠に待機する可能性がある。

**影響**: サーバーリソースの枯渇、ユーザー体験の悪化

**改善理由**: 外部API呼び出しには必ずタイムアウトを設定すべき

**修正方針**:
- `fetch`にタイムアウトを設定（例: 30秒）
- タイムアウト時に適切なエラーを返す

---

### 🟡 優先度A: 重要な問題

#### A-4: データベースエラーの不適切な処理
**問題点**: `server/db.ts`の各関数でデータベースエラーが適切に処理されていない。エラーがそのまま上位に伝播し、内部実装の詳細が露出する可能性がある。

**影響**: セキュリティリスク、デバッグ困難

**改善理由**: データベースエラーは抽象化し、ユーザーフレンドリーなメッセージに変換すべき

**修正方針**:
- try-catchでデータベースエラーをキャッチ
- カスタムエラークラスを定義し、適切なエラーメッセージを返す

---

## 3. セキュリティ（入力検証、認証、脆弱性）

### 🔴 優先度S: 重大なセキュリティ問題

#### S-4: XSS脆弱性のリスク
**問題点**: `client/src/pages/Reader.tsx`で変換結果をそのまま表示している。Gemini APIが悪意のあるスクリプトを含むレスポンスを返した場合、XSS攻撃のリスクがある。

**影響**: ユーザーのセッション乗っ取り、個人情報漏洩

**改善理由**: 外部APIからのレスポンスは信頼できないデータとして扱うべき

**修正方針**:
- DOMPurifyなどのサニタイズライブラリを使用
- `dangerouslySetInnerHTML`の使用を避ける

---

#### S-5: CSRF対策の不足
**問題点**: tRPCエンドポイントにCSRF対策が実装されていない。

**影響**: 悪意のあるサイトからのリクエストによるデータ改ざん

**改善理由**: 状態変更を伴うAPIにはCSRF対策が必須

**修正方針**:
- CSRFトークンを実装
- SameSite Cookie属性を設定

---

### 🟡 優先度A: 重要なセキュリティ問題

#### A-5: APIキーの暗号化不足
**問題点**: `server/db.ts`の`saveApiKey`関数でAPIキーを暗号化して保存しているが、暗号化キーの管理方法が不明確。

**影響**: データベース侵害時のAPIキー漏洩

**改善理由**: 暗号化キーは環境変数で管理し、定期的にローテーションすべき

**修正方針**:
- 暗号化キーを環境変数に移動
- キーローテーション機能を実装

---

## 4. パフォーマンス

### 🟡 優先度A: 重要なパフォーマンス問題

#### A-6: N+1クエリ問題
**問題点**: `server/db.ts`の`getTransformHistory`関数で、履歴を取得した後、各履歴のお気に入り状態を個別にクエリしている可能性がある。

**影響**: データベース負荷増加、レスポンス時間の遅延

**改善理由**: JOINを使用して1回のクエリで取得すべき

**修正方針**:
- Drizzle ORMのリレーション機能を使用
- 1回のクエリで履歴とお気に入り状態を取得

---

#### A-7: クライアントサイドの不要な再レンダリング
**問題点**: `client/src/pages/Home.tsx`で、状態が変更されるたびに全体が再レンダリングされる可能性がある。

**影響**: ユーザー体験の悪化、バッテリー消費

**改善理由**: React.memoやuseMemoを使用して最適化すべき

**修正方針**:
- コンポーネントをReact.memoでラップ
- 高コストな計算をuseMemoで最適化

---

### 🟢 優先度B: 改善推奨

#### B-3: 画像最適化の不足
**問題点**: `client/public/ogp-image.png`などの画像が最適化されていない可能性がある。

**影響**: ページ読み込み速度の低下

**改善理由**: 画像を最適化してファイルサイズを削減すべき

**修正方針**:
- WebP形式に変換
- 適切な解像度にリサイズ

---

## 5. 保守性（拡張性、命名、コメント、テストの有無）

### 🟡 優先度A: 重要な保守性の問題

#### A-8: テストカバレッジの不足
**問題点**: `server/auth.logout.test.ts`、`server/favorites.test.ts`、`server/transform.test.ts`のみテストが存在し、カバレッジが不十分。

**影響**: リグレッションリスク、リファクタリング困難

**改善理由**: 重要なビジネスロジックには必ずテストを書くべき

**修正方針**:
- E2Eテストを追加
- ユニットテストのカバレッジを80%以上に引き上げ

---

#### A-9: 型安全性の不足
**問題点**: 一部の関数で`any`型が使用されている。

**影響**: 型チェックの恩恵を受けられない、バグの混入

**改善理由**: TypeScriptの型システムを最大限活用すべき

**修正方針**:
- `any`型を具体的な型に置き換え
- `strict`モードを有効化

---

### 🟢 優先度B: 改善推奨

#### B-4: ログ出力の不足
**問題点**: サーバーサイドでのログ出力が不十分。エラー発生時の原因追跡が困難。

**影響**: デバッグ困難、運用時の問題解決遅延

**改善理由**: 適切なログ出力は運用に不可欠

**修正方針**:
- Winston等のロギングライブラリを導入
- エラー、警告、情報レベルのログを適切に出力

---

## 優先度別サマリー

| 優先度 | 問題数 | 対応期限 |
|--------|--------|----------|
| S（重大） | 5件 | 即座に対応 |
| A（重要） | 9件 | 1週間以内 |
| B（推奨） | 4件 | 1ヶ月以内 |
| C（軽微） | 1件 | 適宜対応 |

---

## 次のステップ

1. **優先度Sの問題を即座に修正**: APIキー管理、レート制限、タイムアウト設定、XSS対策、CSRF対策
2. **優先度Aの問題を1週間以内に修正**: エラーハンドリング、入力検証、パフォーマンス最適化、テスト追加
3. **リファクタリング計画の策定**: コンポーネント分割、定数化、型安全性向上
4. **CI/CD パイプラインの構築**: 自動テスト、リント、デプロイ自動化

---

## 変更不可領域（重要）

以下の要素は変更禁止です：

- **API仕様**: tRPCのプロシージャ名、引数、戻り値の型
- **DBスキーマ**: テーブル名、カラム名（マイグレーションを通じてのみ変更可能）
- **public関数の名前と引数**: `transformArticle`、`getTransformHistory`など
- **外部サービスとのI/F**: Gemini API、Manus OAuth、Drizzle ORMの使用方法

---

## 結論

本プロジェクトは全体的に良好な設計ですが、セキュリティとエラーハンドリングに重大な問題があります。優先度Sの問題を即座に修正し、優先度Aの問題を1週間以内に対応することで、プロダクションレディな状態に近づけることができます。
