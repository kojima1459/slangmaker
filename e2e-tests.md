# E2Eテスト仕様書

## 概要

本文書は、言い換えメーカー（NewsSkins）のE2Eテストケースを定義します。Playwright等のE2Eテストフレームワークを使用して実装することを想定しています。

---

## テスト環境

- **ブラウザ**: Chrome, Firefox, Safari
- **デバイス**: Desktop, Mobile
- **認証**: Manus OAuth（テストユーザーで実行）

---

## テストケース

### 1. 認証フロー

#### TC-001: ログイン成功
**前提条件**: ユーザーがログアウト状態

**手順**:
1. トップページにアクセス
2. 「ログイン」ボタンをクリック
3. Manus OAuthページにリダイレクトされる
4. テストユーザーでログイン
5. アプリにリダイレクトされる

**期待結果**:
- ユーザー名が表示される
- ログアウトボタンが表示される

---

#### TC-002: ログアウト成功
**前提条件**: ユーザーがログイン状態

**手順**:
1. ログアウトボタンをクリック
2. 確認ダイアログが表示される
3. 「ログアウト」を選択

**期待結果**:
- トップページにリダイレクトされる
- ログインボタンが表示される

---

### 2. 記事変換フロー（正常系）

#### TC-003: 記事変換成功（関西弁）
**前提条件**: 
- ユーザーがログイン状態
- Gemini APIキーが設定済み

**手順**:
1. トップページにアクセス
2. 記事テキストを入力（例: 「今日は良い天気です。」）
3. スキンで「関西弁」を選択
4. 「記事を変換」ボタンをクリック
5. 変換結果ページに遷移

**期待結果**:
- 変換結果が関西弁で表示される（例: 「今日はええ天気やな。」）
- 変換履歴に保存される

---

#### TC-004: 記事変換成功（Z世代スラング）
**前提条件**: 
- ユーザーがログイン状態
- Gemini APIキーが設定済み

**手順**:
1. トップページにアクセス
2. 記事テキストを入力（例: 「今日は良い天気です。」）
3. スキンで「Z世代スラング」を選択
4. 「記事を変換」ボタンをクリック
5. 変換結果ページに遷移

**期待結果**:
- 変換結果がZ世代スラングで表示される（例: 「今日マジで天気良すぎてエモい」）
- 変換履歴に保存される

---

#### TC-005: 詳細設定を使用した変換
**前提条件**: 
- ユーザーがログイン状態
- Gemini APIキーが設定済み

**手順**:
1. トップページにアクセス
2. 記事テキストを入力
3. 「詳細設定」を展開
4. Temperature を 1.5 に設定
5. 出力長比率を 1.2 に設定
6. 「記事を変換」ボタンをクリック

**期待結果**:
- 変換結果が表示される
- 設定した詳細パラメータが反映される

---

### 3. 記事変換フロー（異常系）

#### TC-006: APIキー未設定エラー
**前提条件**: 
- ユーザーがログイン状態
- Gemini APIキーが未設定

**手順**:
1. トップページにアクセス
2. 記事テキストを入力
3. 「記事を変換」ボタンをクリック

**期待結果**:
- エラーメッセージが表示される: 「Gemini APIキーが設定されていません。設定ページで登録してください。」
- 設定ページへのリンクが表示される

---

#### TC-007: 記事が空の場合
**前提条件**: 
- ユーザーがログイン状態
- Gemini APIキーが設定済み

**手順**:
1. トップページにアクセス
2. 記事テキストを空のままにする
3. 「記事を変換」ボタンをクリック

**期待結果**:
- エラーメッセージが表示される: 「記事を入力してください」
- 変換が実行されない

---

#### TC-008: 記事が長すぎる場合
**前提条件**: 
- ユーザーがログイン状態
- Gemini APIキーが設定済み

**手順**:
1. トップページにアクセス
2. 5001文字以上の記事テキストを入力
3. 「記事を変換」ボタンをクリック

**期待結果**:
- エラーメッセージが表示される: 「記事が長すぎます。5000文字以内にしてください。」
- 変換が実行されない

---

#### TC-009: スキン未選択エラー
**前提条件**: 
- ユーザーがログイン状態
- Gemini APIキーが設定済み

**手順**:
1. トップページにアクセス
2. 記事テキストを入力
3. スキンを選択しない
4. 「記事を変換」ボタンをクリック

**期待結果**:
- エラーメッセージが表示される: 「スキンを選択してください」
- 変換が実行されない

---

### 4. 設定ページ

#### TC-010: APIキー設定成功
**前提条件**: ユーザーがログイン状態

**手順**:
1. 設定ページにアクセス
2. Gemini APIキー入力欄に有効なAPIキーを入力
3. 「保存」ボタンをクリック

**期待結果**:
- 成功メッセージが表示される: 「APIキーを保存しました」
- APIキーがデータベースに暗号化されて保存される

---

#### TC-011: デフォルトスキン設定
**前提条件**: ユーザーがログイン状態

**手順**:
1. 設定ページにアクセス
2. デフォルトスキンで「関西弁」を選択
3. 「保存」ボタンをクリック
4. トップページに戻る

**期待結果**:
- トップページで「関西弁」が自動選択されている

---

### 5. 履歴ページ

#### TC-012: 履歴表示
**前提条件**: 
- ユーザーがログイン状態
- 変換履歴が存在する

**手順**:
1. 履歴ページにアクセス

**期待結果**:
- 過去の変換履歴が新しい順に表示される
- 各履歴に日時、スキン名、スニペットが表示される

---

#### TC-013: 履歴から再変換
**前提条件**: 
- ユーザーがログイン状態
- 変換履歴が存在する

**手順**:
1. 履歴ページにアクセス
2. 任意の履歴をクリック
3. 変換結果ページに遷移

**期待結果**:
- 過去の変換結果が表示される

---

### 6. お気に入り機能

#### TC-014: お気に入りスキン追加
**前提条件**: ユーザーがログイン状態

**手順**:
1. トップページにアクセス
2. 「関西弁」スキンのハートアイコンをクリック

**期待結果**:
- ハートアイコンが塗りつぶされる
- お気に入りに追加される

---

#### TC-015: お気に入りスキン削除
**前提条件**: 
- ユーザーがログイン状態
- 「関西弁」がお気に入りに追加済み

**手順**:
1. トップページにアクセス
2. 「関西弁」スキンのハートアイコンをクリック

**期待結果**:
- ハートアイコンが空になる
- お気に入りから削除される

---

### 7. 共有機能

#### TC-016: 変換結果の共有リンク生成
**前提条件**: 
- ユーザーがログイン状態
- 変換結果が表示されている

**手順**:
1. 変換結果ページで「共有」ボタンをクリック
2. 共有リンクが生成される
3. リンクをコピー

**期待結果**:
- 共有リンクがクリップボードにコピーされる
- 成功メッセージが表示される

---

#### TC-017: 共有リンクからアクセス
**前提条件**: 共有リンクが生成済み

**手順**:
1. 共有リンクにアクセス

**期待結果**:
- 変換結果が表示される
- ログイン不要で閲覧可能

---

### 8. フィードバック機能

#### TC-018: フィードバック送信（良い）
**前提条件**: 
- ユーザーがログイン状態
- 変換結果が表示されている

**手順**:
1. 変換結果ページで「良い」ボタンをクリック

**期待結果**:
- フィードバックが送信される
- 成功メッセージが表示される

---

#### TC-019: フィードバック送信（悪い）
**前提条件**: 
- ユーザーがログイン状態
- 変換結果が表示されている

**手順**:
1. 変換結果ページで「悪い」ボタンをクリック

**期待結果**:
- フィードバックが送信される
- 成功メッセージが表示される

---

### 9. レスポンシブデザイン

#### TC-020: モバイル表示
**前提条件**: なし

**手順**:
1. モバイルデバイスでトップページにアクセス

**期待結果**:
- レイアウトがモバイルに最適化されている
- すべての機能が正常に動作する

---

### 10. パフォーマンス

#### TC-021: ページ読み込み速度
**前提条件**: なし

**手順**:
1. トップページにアクセス
2. ページ読み込み時間を計測

**期待結果**:
- 初回読み込み: 3秒以内
- 2回目以降: 1秒以内

---

## テスト実装例（Playwright）

```typescript
// e2e/transform.spec.ts
import { test, expect } from '@playwright/test';

test.describe('記事変換フロー', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン処理（テストユーザーで）
    await page.goto('/');
    await page.click('text=ログイン');
    // Manus OAuth認証処理（省略）
  });

  test('TC-003: 記事変換成功（関西弁）', async ({ page }) => {
    // トップページにアクセス
    await page.goto('/');

    // 記事テキストを入力
    await page.fill('textarea[placeholder*="記事"]', '今日は良い天気です。');

    // スキンで「関西弁」を選択
    await page.click('button:has-text("関西弁")');

    // 「記事を変換」ボタンをクリック
    await page.click('button:has-text("記事を変換")');

    // 変換結果ページに遷移
    await page.waitForURL('/reader');

    // 変換結果が表示される
    const result = await page.textContent('.transformed-text');
    expect(result).toContain('や');  // 関西弁の特徴

    // 変換履歴に保存される
    await page.goto('/history');
    const history = await page.textContent('.history-list');
    expect(history).toContain('関西弁');
  });

  test('TC-006: APIキー未設定エラー', async ({ page }) => {
    // APIキーを削除
    await page.goto('/settings');
    await page.fill('input[name="apiKey"]', '');
    await page.click('button:has-text("保存")');

    // トップページにアクセス
    await page.goto('/');

    // 記事テキストを入力
    await page.fill('textarea[placeholder*="記事"]', '今日は良い天気です。');

    // スキンを選択
    await page.click('button:has-text("関西弁")');

    // 「記事を変換」ボタンをクリック
    await page.click('button:has-text("記事を変換")');

    // エラーメッセージが表示される
    const error = await page.textContent('.error-message');
    expect(error).toContain('APIキーが設定されていません');
  });

  test('TC-008: 記事が長すぎる場合', async ({ page }) => {
    // トップページにアクセス
    await page.goto('/');

    // 5001文字以上の記事テキストを入力
    const longText = 'あ'.repeat(5001);
    await page.fill('textarea[placeholder*="記事"]', longText);

    // スキンを選択
    await page.click('button:has-text("関西弁")');

    // 「記事を変換」ボタンをクリック
    await page.click('button:has-text("記事を変換")');

    // エラーメッセージが表示される
    const error = await page.textContent('.error-message');
    expect(error).toContain('長すぎます');
  });
});
```

---

## テスト実行コマンド

```bash
# Playwrightのインストール
pnpm add -D @playwright/test

# テスト実行
pnpm exec playwright test

# UIモードで実行
pnpm exec playwright test --ui

# 特定のテストのみ実行
pnpm exec playwright test e2e/transform.spec.ts
```

---

## カバレッジ目標

- **機能カバレッジ**: 90%以上
- **コードカバレッジ**: 80%以上
- **クリティカルパスカバレッジ**: 100%

---

## 結論

本E2Eテスト仕様書は、言い換えメーカーの主要機能をカバーしています。これらのテストを実装することで、リグレッションを防ぎ、品質を保証できます。
